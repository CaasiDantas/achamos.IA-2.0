<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compartilhar Localiza√ß√£o | Premium</title>
  <link rel="manifest" href="/manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* CSS PREMIUM INTEGRADO */
    :root {
      --bg-primary: #0f172a;
      --primary: #6366f1;
      --primary-glow: rgba(99, 102, 241, 0.5);
      --success: #10b981;
      --danger: #ef4444;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --glass-bg: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

    body {
      min-height: 100vh;
      background-color: var(--bg-primary);
      background-image: 
        radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.1) 0px, transparent 50%);
      display: flex; align-items: center; justify-content: center;
      padding: 24px; font-family: 'Inter', sans-serif; color: var(--text-main);
    }

    .container {
      width: 100%; max-width: 400px;
      background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border); border-radius: 24px;
      padding: 48px 32px; text-align: center;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
      animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    h2 { font-size: 1.8rem; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.025em; }
    p.desc { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 32px; }

    input[type="email"] {
      width: 100%; padding: 16px; border-radius: 14px; border: 1px solid var(--glass-border);
      background: rgba(15, 23, 42, 0.6); color: white; outline: none; transition: 0.2s;
      font-size: 1rem; margin-bottom: 16px;
    }

    input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-glow); }

    button {
      width: 100%; padding: 16px; border-radius: 14px; border: none;
      background: #fff; color: #0f172a; font-size: 0.9rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; transition: 0.3s;
    }

    button:hover { transform: translateY(-2px); background: #f1f5f9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    #status { margin-top: 24px; font-size: 0.85rem; font-weight: 500; min-height: 1.2rem; transition: 0.3s; }
    .active { color: var(--success); }
    .error { color: var(--danger); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); filter: blur(10px); }
      to { opacity: 1; transform: translateY(0); filter: blur(0); }
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>Transmiss√£o</h2>
    <p class="desc">Sua localiza√ß√£o ser√° compartilhada em tempo real com o painel administrativo.</p>

    <input type="email" id="email" placeholder="Seu e-mail profissional" required />
    <button id="btn-iniciar" onclick="handleIniciar()">Ativar Rastreio</button>

    <p id="status"></p>
  </div>

  <script>
    let watchId = null;

    // Detecta mudan√ßa de conex√£o para alertar o usu√°rio
    window.addEventListener('offline', () => updateStatus('‚ùå Offline. O envio foi pausado.', 'error'));
    window.addEventListener('online', () => updateStatus('üåê Conex√£o restaurada!', 'active'));

    function updateStatus(text, className) {
      const statusEl = document.getElementById('status');
      statusEl.innerText = text;
      statusEl.className = className;
    }

    function handleIniciar() {
      const email = document.getElementById('email').value;
      const btn = document.getElementById('btn-iniciar');

      if (!email || !email.includes('@')) {
        updateStatus('Insira um e-mail v√°lido.', 'error');
        return;
      }

      // Interface em modo "Ativo"
      btn.innerText = 'Compartilhando...';
      btn.disabled = true;
      updateStatus('Solicitando GPS...', '');

      watchId = navigator.geolocation.watchPosition(
        position => {
          // Se n√£o houver internet, n√£o tenta o fetch para economizar recursos
          if (!navigator.onLine) {
            updateStatus('‚ùå Sem internet para transmitir.', 'error');
            return;
          }

          updateStatus('üì° Sinal ativo e transmitindo', 'active');

          const data = {
            email: email,
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            date: new Date().toISOString()
          };

          fetch('/api/location', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          }).catch(err => {
            console.error("Erro de rede:", err);
            updateStatus('‚ö†Ô∏è Erro ao alcan√ßar servidor.', 'error');
          });
        },
        error => {
          btn.disabled = false;
          btn.innerText = 'Ativar Rastreio';
          let msg = 'Erro ao obter GPS.';
          if (error.code === 1) msg = 'Acesso ao GPS negado pelo usu√°rio.';
          updateStatus(msg, 'error');
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 15000
        }
      );
    }
  </script>
</body>
</html>